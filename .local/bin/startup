#!/bin/bash
set -e

if [[ "$1" == "-n" || "$1" == "--name" ]]
then
    shift
    PROG="$1"
    shift
else
    PROG="$1"
fi
PIDFILE="$XDG_RUNTIME_DIR/$PROG-$XDG_SESSION_ID.pid"


function wait_pid() {
    local pid=$1
    kill -SIGTERM $pid || true
    while [ "$(kill -0 $pid)" ]
    do
        sleep .6
    done
}

if [[ -f "$PIDFILE" ]] 
then
    pid="$(cat $PIDFILE)"
    wait_pid $pid
fi
unset pid code

eval "$@ &" 
pid=$!

echo "$pid" > "$PIDFILE"
